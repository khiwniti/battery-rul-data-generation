# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Battery RUL (Remaining Useful Life) Prediction system designed to monitor, analyze, and predict the health of battery systems in data centers across Thailand. The system tracks batteries in UPS and Rectifier systems, collecting telemetry data, maintenance records, and generating ML-based predictions for battery failures.

## Data Architecture

The system uses a comprehensive relational data schema organized into seven phases:

### Phase 1: Master Data
Reference tables with static/slow-changing configuration:
- **location**: Data center sites (9 locations across Thai regions)
- **battery_system**: UPS/Rectifier systems (18-27 systems fleet-wide)
- **string**: Battery strings - series-connected batteries (81 strings, typically 24 batteries per string)
- **battery**: Individual battery jars (1,944 batteries fleet-wide)
- **battery_model**: Battery specifications and thresholds
- **environmental_sensor**: Temperature/humidity sensors
- **user**: System users
- **ml_model**: ML model registry

### Phase 2-3: Raw Data
Direct sensor readings and transactional records (synthesize these first):
- **telemetry_jar_raw**: Per-battery telemetry (voltage, temperature, resistance) at 5-second intervals
- **telemetry_string_raw**: Per-string telemetry (voltage, current, mode, ripple) at 5-second intervals
- **telemetry_env**: Environmental sensors (temperature, humidity) at 60-second intervals
- **maintenance_event**: Scheduled/unscheduled maintenance records
- **capacity_test_raw**: Discharge test results
- **impedance_measurement_raw**: Per-battery impedance snapshots

### Phase 4-5: Calculated Data
Derived values computed from raw data (compute after synthesis):
- **telemetry_jar_calc**: Calculated values (SOC, SOH) from raw telemetry
- **telemetry_string_calc**: Power, THD calculated from string telemetry
- **feature_store**: Pre-computed aggregated features for ML (hourly windows)
- **digital_twin_state**: ECM model parameters and battery state estimation
- **capacity_test_calc**: Calculated capacity metrics
- **impedance_measurement_calc**: Temperature-normalized resistance values

### Phase 6-7: Derived Operational Data
Generated by ML models, rule engines, or workflow systems:
- **rul_prediction**: ML-generated RUL predictions with confidence intervals
- **alert**: Rule/ML-generated alerts (voltage, temperature, resistance drift, anomalies)
- **incident**: Correlated/grouped alerts
- **work_order**: ITSM/CMMS work orders derived from incidents

## Data Dependencies

**Critical**: Always follow the synthesis order defined in the schema:
1. Master Data → 2. Raw Time-Series → 3. Raw Transactional → 4. Calculated Telemetry → 5. Calculated Aggregates → 6. ML/Digital Twin → 7. Derived Operations

This ensures data dependencies are satisfied. For example:
- Raw telemetry must exist before calculating SOC/SOH
- Feature store depends on both raw and calculated telemetry
- RUL predictions require feature store and digital twin state

## Fleet Scale Reference

- **9 locations** across Thai regions (northern, northeastern, central, eastern, southern)
- **1,944 batteries** total (216 per site)
- **81 strings** (9 per site, 24 batteries per string)
- **18-27 battery systems** (2-3 per site: Rectifier + UPS)

## Telemetry Volume

High-frequency data generation:
- `telemetry_jar_raw`: 33.6M records/day (5-second sampling)
- `telemetry_string_raw`: 1.4M records/day (5-second sampling)
- `telemetry_env`: 26K-52K records/day (60-second sampling)
- `feature_store`: 46.7K records/day (hourly aggregation)

## Battery Chemistry & Specifications

Primary chemistry: **VRLA (Valve-Regulated Lead-Acid)**
- Nominal voltage: 12.0V per jar
- Typical capacity: 120 Ah
- Float voltage range: 13.50-13.80V
- String configuration: 24 batteries in series (288V nominal)
- Operating modes: float, boost, discharge, idle, equalize

## Degradation Profiles

Fleet distribution for synthetic data:
- **85% healthy**: 2% SOH decline/year, 5% resistance increase/year
- **12% accelerated aging**: 8% SOH decline/year, 15% resistance increase/year
- **3% failing**: 25% SOH decline/year, 40% resistance increase/year, sudden events

## Key Data Classifications

**Raw Data** = Direct sensor readings and transactional records (synthesize first)
**Calculated Data** = Derived/computed values from raw data (compute after synthesis)
**Master Data** = Reference tables with static/slow-changing data

## Database Considerations

- Use time-series partitioning for telemetry tables (monthly partitions by timestamp)
- Hash partitioning by battery_id/string_id for distributed queries
- Implement recommended indexes for high-frequency queries (see data_schema.md:771-793)
- JSONB columns store flexible data (feature snapshots, SHAP explanations, hyperparameters)

## ML/Digital Twin Components

**Digital Twin**: Uses ECM (Equivalent Circuit Model) with parameters R₀, R₁, C₁, R₂, C₂ for battery state estimation via EKF (Extended Kalman Filter)

**RUL Prediction**: Multiple model types supported:
- CatBoost for RUL regression
- Isolation Forest / Autoencoder for anomaly detection
- Survival models for failure probability estimation
- Model fusion combining ML + digital twin predictions

## Alert System

Alert types include:
- Threshold-based: voltage_low/high, temperature_high, current_high, ripple_high
- Calculated: resistance_drift, soh_degraded
- ML-generated: rul_warning/critical, anomaly_detected
- Data quality alerts

Severity levels: info, warning, critical
Sources: rule_engine, ml_model, digital_twin, manual

## Maintenance Schedule

Event types defined in maintenance_event:
- Monthly: visual_inspection, voltage_measurement
- Quarterly: thermal_survey (IR scans)
- Periodic: torque_check, capacity_test, impedance_test
- As-needed: replacement, corrective
